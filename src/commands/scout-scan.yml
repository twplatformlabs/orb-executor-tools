# src/commands/scout-scan.yml
# yamllint disable rule:line-length
---
description: |
  Run Docker Scout CVE scan based on contents of docker-bake file.
  Optionally, upload scan log as save artifact and persist to pipeline workspace.
  Specifically requires dockerhub credentials.

  Log file name: << parameters.tag >>_snyk_log.txt

parameters:

  bake-file:
    description: Name of docker-bake.json file. Default is docker-bake.json.
    type: string
    default: "docker-bake.json"

  outfile:
    description: Name of output file. Default is scout.out.
    type: string
    default: "scout.out"

  docker-login:
    description: Environment variable containing Username for Dockerhub access. Default is DOCKER_LOGIN.
    type: env_var_name
    default: DOCKER_LOGIN

  docker-password:
    description: Environment variable containing Password for Dockerhub access. Default is DOCKER_PASSWORD.
    type: env_var_name
    default: DOCKER_PASSWORD

steps:
  - run:
      name: Docker Scout CVE scan based on docker bake file targets
      environment:
        DOCKER_LOGIN: << parameters.docker-login >>
        DOCKER_PASSWORD: << parameters.docker-password >>
        BAKEFILE: << parameters.bake-file >>
        OUTFILE: << parameters.outfile >>
      command: <<include(scripts/scout_scan.sh)>>
