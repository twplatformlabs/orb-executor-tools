# src/jobs/dev-release.yml
# yamllint disable rule:line-length
---
description: Continuous integration and development build of circleci remote-docker executor.

executor:
  name: circleci-executor-builder
  image: << parameters.executor-image-name >>
  resource-class: << parameters.executor-resource-class >>
  registry-login: << parameters.registry-login >>
  registry-password: << parameters.registry-password >>

shell: << parameters.shell >>

parameters:

  shell:
    description: Default shell invocation.
    type: string
    default: /bin/bash -eo pipefail

  executor-image-name:
    description: Remote-docker executor image. Default is twdps/circleci-executor-builder:latest.
    type: string
    default: twdps/circleci-executor-builder:latest

  executor-resource-class:
    description: Executor resource class. Default is medium.
    type: enum
    enum: [medium, medium+, large, xlarge, 2xlarge, 2xlarge+]
    default: medium

  bake-file:
    description: Name of docker-bake.json file. Default is docker-bake.json.
    type: string
    default: "docker-bake.json"

  target:
    description: Bake file build target. Default is default.
    type: string
    default: "default"

  op-version:
    description: Specify specific 1Password CLI version. Default assumes version already installed on executor.
    type: string
    default: ""

  vault-version:
    description: Specify specific Hashi Vault CLI version. Default assumes version already installed on executor.
    type: string
    default: ""

  scout-scan:
    description: Perform Docker Scout CVE scan of all targets in bake file. Default is false.
    type: boolean
    default: false

  scout-outfile:
    description: Name of output file for Docker Scout CVE scan. Default is scout.out.
    type: string
    default: "scout.out"

  bats-version:
    description: Specify specific Bats CLI version. Default assumes version already installed on executor.
    type: string
    default: ""

  bats-test:
    description: Run bats container configuration health check. Default is false.
    type: boolean
    default: false

  bats-run-container-name:
    description: Name assigned to running container. Default is container-test.
    type: string
    default: container-test

  bats-entry-point:
    description: Name of shell entrypoint for bats test. Default is /bin/bash.
    type: string
    default: /bin/bash

  bats-test-path:
    description: Name of folder with tests. Default is test.
    type: string
    default: test

  hadolint-version:
    description: Specify specific Hadolint CLI version. Default assumes version already installed on executor.
    type: string
    default: ""

  hadolint-additional-args:
    description: Additional Hadolint CLI command line flags.
    type: string
    default: ""

  registry:
    description: Name of registry. Default is docker.io
    type: string
    default: docker.io

  registry-login:
    description: Environment variable containing Username for reigstry access. Default is DOCKER_LOGIN.
    type: env_var_name
    default: DOCKER_LOGIN

  registry-password:
    description: Environment variable containing Password for reigstry access. Default is DOCKER_PASSWORD.
    type: env_var_name
    default: DOCKER_PASSWORD

  tag:
    description: Value for dev build tag. Default is dev.${CIRCLE_SHA1:0:7}.
    type: string
    default: dev.${CIRCLE_SHA1:0:7}

  extra-build-args:
    description: Extra flags to pass to docker build.
    type: string
    default: ""

  after-checkout:
    description: Optional steps to run after checking out the code.
    type: steps
    default: []

  before-build:
    description: Optional steps to run before building the docker image.
    type: steps
    default: []

  after-build:
    description: Optional steps to run after building the docker image.
    type: steps
    default: []

steps:
  - checkout
  - setup_remote_docker
  - install:
      op-version: << parameters.op-version >>
      vault-version: << parameters.vault-version >>
      bats-version: << parameters.bats-version >>
      hadolint-version: << parameters.hadolint-version >>
  - when:
      name: Run after-checkout lifecycle hook steps
      condition: << parameters.after-checkout >>
      steps: << parameters.after-checkout >>
  - run:
      name: setup artifact workspace
      command: mkdir -p workspace
  - lint:
      dockerfile: "Dockerfile.*"
      hadolint-additional-args: << parameters.hadolint-additional-args >>
  - confirm-registry:
      registry: << parameters.registry >>
      registry-login: << parameters.registry-login >>
      registry-password: << parameters.registry-password >>
  - when:
      name: Run before-build lifecycle hook steps
      condition: << parameters.before-build >>
      steps: << parameters.before-build >>
  - buildx:
      tag: << parameters.tag >>
      bake-file: << parameters.bake-file >>
      target: << parameters.target >>
      extra-build-args: << parameters.extra-build-args >>
  - when:
      name: Perform Docker Scout CVE scan
      condition: << parameters.scout-scan >>
      requires:
        - buildx
      steps:
        - scout-scan:
            bake-file: << parameters.bake-file >>
            outfile: << parameters.scout-outfile >>
  - when:
      name: Run bats container configuration health check
      condition: << parameters.bats-test >>
      requires:
        - buildx
      steps:
        - run:
            name: Run bats container configuration health check on targets in bake file.
            environment:
              BAKEFILE: << parameters.bake-file >>
              BATS_ENTRY_POINT: << parameters.bats-entry-point >>
              BATS_TEST_PATH: << parameters.bats-test-path >>
            command: <<include(scripts/bats_scan.sh)>>
  - when:
      name: Run after-build lifecycle hook steps.
      condition: << parameters.after-build >>
      steps: << parameters.after-build >>
  - persist-workspace
